require('dotenv').config();
const { Telegraf } = require('telegraf');
const mongoose = require('mongoose');
const User = require('./models/user');
const bot = new Telegraf(process.env.TELEGRAM_BOT_TOKEN);

async function sendNotification(telegramId, message, useQuote = false) {
    try {
        let formattedMessage = message;
        let parseMode = 'MarkdownV2';

        if (useQuote) {
            const escapeMarkdownV2 = (text) => {
                return text.replace(/[_*[\]()~`>#+\-=|{}.!]/g, '\\$&');
            };
            const escapedMessage = escapeMarkdownV2(message);
            formattedMessage = escapedMessage.split('\n').map(line => `> ${line}`).join('\n');
        }

        await bot.telegram.sendMessage(telegramId, formattedMessage, { parse_mode: parseMode });
    } catch (error) {
        console.error(`Gagal mengirim notifikasi ke ${telegramId}:`, error.description);
        if (error.code === 403) {
            await User.findOneAndUpdate({ telegramId }, { telegramId: null });
        } else if (error.code === 400 && error.description.includes("Can't parse entities")) {
            await bot.telegram.sendMessage(telegramId, message);
        }
    }
}

bot.start(async (ctx) => {
    const webUserId = ctx.startPayload;
    const telegramId = ctx.from.id;

    if (!webUserId || !mongoose.Types.ObjectId.isValid(webUserId)) {
        return ctx.reply('Link aktivasi tidak valid. Silakan coba lagi dari halaman pengaturan di website.');
    }

    try {
        const user = await User.findById(webUserId);
        if (!user) {
            return ctx.reply('Pengguna tidak ditemukan di website kami.');
        }

        user.telegramId = telegramId;
        await user.save();

        await ctx.reply(`ðŸŽ‰ Halo ${user.username}! Akun Anda berhasil terhubung. Anda akan menerima notifikasi di sini.`);

        sendNotification(telegramId, 'Ini adalah notifikasi tes dengan kutipan. Anda siap menerima update!', true);
        sendNotification(telegramId, 'Ini notifikasi biasa tanpa kutipan.');

    } catch (error) {
        console.error('Error saat menghubungkan akun Telegram:', error);
        ctx.reply('Terjadi kesalahan di server kami. Silakan coba beberapa saat lagi.');
    }
});

bot.help((ctx) => ctx.reply('Bot ini akan mengirimkan notifikasi dari akun Job Freelance Anda.'));

module.exports = {
    bot,
    sendNotification
};

if (require.main === module) {
    mongoose.connect(process.env.MONGO_URI).then(() => {
        console.log('Bot Telegram terhubung ke MongoDB.');
        bot.launch();
        console.log('Bot Telegram sedang berjalan...');
    }).catch(err => console.error('Koneksi DB untuk bot gagal', err));

    process.once('SIGINT', () => bot.stop('SIGINT'));
    process.once('SIGTERM', () => bot.stop('SIGTERM'));
}