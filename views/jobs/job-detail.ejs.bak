<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head', { title: title }) %>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="main-body">
    <%- include('../partials/header') %>

    <main class="main-content-container job-detail-page">
        <div class="job-detail-header glass-effect">
            <h1><%= job.title %></h1>
            <div class="job-meta-header">
                <span><i class="fas fa-tag icon"></i> <%= job.category %></span>
                <span><i class="fas fa-dollar-sign icon"></i> Budget: $<%= job.budget.toLocaleString() %></span>
                <span><i class="fas fa-clock icon"></i> Deadline: <%= new Date(job.deadline).toLocaleDateString('id-ID') %></span>
                <span><i class="fas fa-info-circle icon"></i> Status: <%= job.status %></span>
            </div>
        </div>

        <div class="job-detail-grid">
            <div class="job-detail-main glass-effect">
                <h3><i class="fas fa-file-alt icon"></i> Deskripsi Pekerjaan</h3>
                <p><%= job.description %></p>

                <% if (job.attachments && job.attachments.length > 0) { %>
                    <h4><i class="fas fa-paperclip icon"></i> Lampiran</h4>
                    <ul class="attachment-list">
                        <% job.attachments.forEach(file => { %>
                            <li><a href="<%= file %>" target="_blank" rel="noopener noreferrer"><i class="fas fa-file"></i> <%= file.split('/').pop() %></a></li>
                        <% }) %>
                    </ul>
                <% } %>

                <!-- Proposal Section -->
                <% if (currentUser && currentUser.role === 'freelancer' && job.status === 'open' && !hasProposed) { %>
                    <div class="proposal-form-section">
                        <h3><i class="fas fa-paper-plane icon"></i> Ajukan Proposal Anda</h3>
                        <form id="proposalForm">
                            <input type="hidden" name="jobId" value="<%= job._id %>">
                            <div class="form-group">
                                <label for="proposedBudget">Budget yang Diajukan ($)</label>
                                <input type="number" id="proposedBudget" name="proposedBudget" required>
                            </div>
                            <div class="form-group">
                                <label for="deliveryTime">Waktu Pengiriman (hari)</label>
                                <input type="number" id="deliveryTime" name="deliveryTime" required>
                            </div>
                            <div class="form-group">
                                <label for="coverLetter">Surat Lamaran</label>
                                <textarea id="coverLetter" name="coverLetter" rows="5" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Kirim Proposal</button>
                        </form>
                    </div>
                <% } else if (currentUser && currentUser.role === 'freelancer' && hasProposed) { %>
                    <div class="info-message glass-effect">
                        <i class="fas fa-check-circle icon"></i> Anda sudah mengajukan proposal untuk pekerjaan ini.
                    </div>
                <% } %>

                <!-- Proposals List (for client) -->
                <% if (currentUser && currentUser._id.toString() === job.clientId._id.toString() && job.proposals && job.proposals.length > 0) { %>
                    <div class="proposals-list-section">
                        <h3><i class="fas fa-users icon"></i> Proposal yang Masuk (<%= job.proposals.length %>)</h3>
                        <% job.proposals.forEach(proposal => { %>
                            <div class="proposal-card glass-effect">
                                <div class="proposal-header">
                                    <img src="<%= proposal.freelancerId.avatar || '/images/default-avatar.png' %>" alt="<%= proposal.freelancerId.username %>" class="proposal-avatar">
                                    <div class="proposal-freelancer-info">
                                        <h4><a href="/users/profile/<%= proposal.freelancerId._id %>"><%= proposal.freelancerId.username %></a></h4>
                                        <span><%= proposal.freelancerId.averageRating.toFixed(1) %> <i class="fas fa-star star-icon"></i> (<%= proposal.freelancerId.totalReviews %> ulasan)</span>
                                    </div>
                                    <div class="proposal-bid-info">
                                        <span>Budget: $<%= proposal.proposedBudget.toLocaleString() %></span>
                                        <span>Waktu: <%= proposal.deliveryTime %> hari</span>
                                    </div>
                                </div>
                                <p class="proposal-coverletter">"<%= proposal.coverLetter %>"</p>
                                <% if (job.status === 'open') { %>
                                    <div class="proposal-actions">
                                        <button class="btn btn-primary accept-proposal-btn" data-job-id="<%= job._id %>" data-proposal-id="<%= proposal._id %>">
                                            <i class="fas fa-check"></i> Terima & Mulai Proyek
                                        </button>
                                        <button class="btn btn-secondary chat-freelancer-btn" data-freelancer-id="<%= proposal.freelancerId._id %>">
                                            <i class="fas fa-comments"></i> Chat
                                        </button>
                                    </div>
                                <% } %>
                            </div>
                        <% }) %>
                    </div>
                <% } %>
            </div>
            <aside class="job-detail-sidebar glass-effect">
                <h3><i class="fas fa-user-tie icon"></i> Tentang Klien</h3>
                <div class="client-info">
                    <img src="<%= job.clientId.avatar || '/images/default-avatar.png' %>" alt="<%= job.clientId.username %>" class="client-avatar">
                    <h4><a href="/users/profile/<%= job.clientId._id %>"><%= job.clientId.username %></a></h4>
                    <!-- Tambahkan info klien lain seperti rating, jumlah pekerjaan, dll. -->
                    <p>Lokasi, Waktu Lokal, dll.</p>
                </div>
                <% if (currentUser && currentUser._id.toString() !== job.clientId._id.toString()) { %>
                    <a href="/chat/<%= job.clientId._id %>" class="btn btn-primary full-width"><i class="fas fa-comments"></i> Hubungi Klien</a>
                <% } %>
            </aside>
        </div>
    </main>

    <%- include('../partials/footer') %>
    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Submit Proposal
            document.getElementById('proposalForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/jobs/proposal', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert(result.message);
                        location.reload();
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error submitting proposal:', error);
                    alert('Gagal mengirim proposal.');
                }
            });

            // Accept Proposal
            document.querySelectorAll('.accept-proposal-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const jobId = btn.dataset.jobId;
                    const proposalId = btn.dataset.proposalId;
                    if (confirm('Apakah Anda yakin ingin menerima proposal ini dan memulai proyek? Proposal lain akan ditolak secara otomatis.')) {
                        try {
                            const response = await fetch('/jobs/accept-proposal', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ jobId, proposalId })
                            });
                            const result = await response.json();
                            if (result.success) {
                                alert(result.message);
                                location.reload();
                            } else {
                                alert('Error: ' + result.message);
                            }
                        } catch (error) {
                            console.error('Error accepting proposal:', error);
                            alert('Gagal menerima proposal.');
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>