<!-- views/jobs/job-detail.ejs (FIXED & COMPLETE) -->
<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head', { title: title }) %>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="main-body">
    <%- include('../partials/header', { currentUser: locals.currentUser || null }) %>
    <main class="main-content-container job-detail-page">
        <div class="job-detail-header glass-effect">
            <h1><%= job.title %></h1>
            <div class="job-meta-header">
                <span><i class="fas fa-tag icon"></i> <%= job.category %></span>
                <span><i class="fas fa-money-bill-wave icon"></i> Budget: <strong>Rp <%= job.budget.toLocaleString('id-ID') %></strong></span>
                <span><i class="fas fa-clock icon"></i> Deadline: <%= new Date(job.deadline).toLocaleDateString('id-ID') %></span>
            </div>
        </div>
        <div class="job-detail-grid">
            <div class="job-detail-main glass-effect">
                <h3><i class="fas fa-file-alt icon"></i> Deskripsi Pekerjaan</h3>
                <p><%- job.description.replace(/\n/g, '<br>') %></p>

                <!-- =================================== -->
                <!--    BAGIAN AJUKAN PROPOSAL BARU    -->
                <!-- =================================== -->
                <% if (currentUser && currentUser.role === 'freelancer' && job.status === 'open' && !hasProposed) { %>
                    <div class="proposal-form-section">
                        <h3><i class="fas fa-paper-plane icon"></i> Ajukan Proposal Anda</h3>
                        <form id="proposalForm">
                            <input type="hidden" name="jobId" value="<%= job._id %>">
                            <div class="form-group">
                                <label for="proposedBudget">Budget yang Anda Ajukan (IDR)</label>
                                <input type="number" id="proposedBudget" name="proposedBudget" placeholder="Contoh: 1500000" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="deliveryTime">Perkiraan Waktu Pengiriman (dalam hari)</label>
                                <input type="number" id="deliveryTime" name="deliveryTime" placeholder="Contoh: 7" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="coverLetter">Surat Lamaran</label>
                                <textarea id="coverLetter" name="coverLetter" rows="6" placeholder="Jelaskan mengapa Anda adalah kandidat terbaik untuk pekerjaan ini. Tonjolkan keahlian dan pengalaman relevan Anda." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary full-width">Kirim Proposal</button>
                        </form>
                    </div>
                <% } else if (currentUser && currentUser.role === 'freelancer' && hasProposed) { %>
                    <div class="info-message glass-effect">
                        <i class="fas fa-check-circle icon"></i> Anda sudah mengajukan proposal untuk pekerjaan ini. Statusnya dapat dilihat di halaman "Proposal Saya".
                    </div>
                <% } %>
                <!-- =================================== -->
                <!--    AKHIR BAGIAN PROPOSAL          -->
                <!-- =================================== -->

            </div>
            <aside class="job-detail-sidebar glass-effect">
                <h3><i class="fas fa-user-tie icon"></i> Tentang Klien</h3>
                <div class="client-info">
                    <img src="<%= job.clientId.avatar || '/images/default-avatar.png' %>" alt="<%= job.clientId.username %>" class="client-avatar">
                    <h4><a href="/users/profile/<%= job.clientId._id %>"><%= job.clientId.username %></a></h4>
                </div>
                <% if (currentUser && currentUser._id.toString() !== job.clientId._id.toString()) { %>
                    <a href="/chat/<%= job.clientId._id %>" class="btn btn-primary full-width">
                        <i class="fas fa-comments"></i> Chat Klien
                    </a>
                <% } %>
            </aside>
        </div>
    </main>
    <%- include('../partials/footer', { currentUser: locals.currentUser || null }) %>
   <script src="/js/main.js"></script>
     <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Submit Proposal
            document.getElementById('proposalForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/jobs/proposal', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert(result.message);
                        location.reload();
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error submitting proposal:', error);
                    alert('Gagal mengirim proposal.');
                }
            });

            // Accept Proposal
            document.querySelectorAll('.accept-proposal-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const jobId = btn.dataset.jobId;
                    const proposalId = btn.dataset.proposalId;
                    if (confirm('Apakah Anda yakin ingin menerima proposal ini dan memulai proyek? Proposal lain akan ditolak secara otomatis.')) {
                        try {
                            const response = await fetch('/jobs/accept-proposal', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ jobId, proposalId })
                            });
                            const result = await response.json();
                            if (result.success) {
                                alert(result.message);
                                location.reload();
                            } else {
                                alert('Error: ' + result.message);
                            }
                        } catch (error) {
                            console.error('Error accepting proposal:', error);
                            alert('Gagal menerima proposal.');
                        }
                    }
                });
            });
        });
    </script
</body>
</html>